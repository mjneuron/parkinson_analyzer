<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Tremor Guard Pro</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --warning: #f39c12; --success: #27ae60; --light: #f4f7f9; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light); color: var(--primary); margin: 0; padding: 0; overflow-x: hidden; }
        .container { max-width: 450px; margin: auto; padding: 20px; box-sizing: border-box; min-height: 100vh; position: relative; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 12px 40px rgba(0,0,0,0.1); position: relative; }
        .view { display: none; }
        .view.active { display: block; }

        /* ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .menu-btn { position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; border-radius: 50%; width: 45px; height: 45px; display: none; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 1.5rem; }
        .menu-overlay { position: fixed; top: 0; right: -100%; width: 280px; height: 100%; background: white; z-index: 1001; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 70px 20px 20px 20px; box-sizing: border-box; }
        .menu-overlay.open { right: 0; }
        .menu-item { padding: 18px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; }
        .menu-close { position: absolute; top: 20px; left: 20px; font-size: 1.2rem; cursor: pointer; }

        /* ë²„íŠ¼ ë° ë¦¬ìŠ¤íŠ¸ */
        button { background: var(--accent); color: white; border: none; padding: 15px; font-size: 1.1rem; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        button:disabled { background: #bdc3c7; }
        input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 10px; }
        .item-list { list-style: none; padding: 0; margin-top: 20px; }
        .item-list li { background: #fff; padding: 16px; border-radius: 14px; margin-bottom: 12px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { color: var(--danger); font-size: 1.2rem; cursor: pointer; padding: 5px; }

        /* ê²°ê³¼ UI */
        .hz-display { font-size: 3.8rem; font-weight: 900; margin: 15px 0; text-align: center; }
        .prob-box { font-weight: bold; padding: 12px; border-radius: 14px; background: #f8f9fa; margin-bottom: 10px; text-align: center; transition: 0.3s; }
        .chart-container { height: 160px; margin-top: 15px; }
        #noiseAlert { display: none; background: var(--warning); color: white; padding: 10px; text-align: center; border-radius: 10px; margin-bottom: 10px; }
        #status { font-size: 0.95rem; text-align: center; min-height: 3em; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <div id="menuBtn" class="menu-btn" onclick="toggleMenu()">â˜°</div>
    <div id="menuOverlay" class="menu-overlay">
        <div class="menu-close" onclick="toggleMenu()">âœ• ë‹«ê¸°</div>
        <div id="backToMeasureItem" class="menu-item" style="color: var(--accent); display:none;" onclick="showView('measureView')">ğŸ  í˜„ì¬ ì¸¡ì • í™”ë©´ìœ¼ë¡œ</div>
        <div class="menu-item" onclick="showHistory()">ğŸ“Š ë°ì´í„° ë¹„êµ í…Œì´ë¸”</div>
        <div class="menu-item" onclick="goToSubjectList()">ğŸ‘¥ ëŒ€ìƒì ëª©ë¡ (ë³€ê²½)</div>
        <div class="menu-item" style="color: var(--danger);" onclick="logout()">ğŸƒ ë¡œê·¸ì•„ì›ƒ</div>
    </div>

    <div id="loginView" class="view active">
        <div class="card" style="text-align: center; margin-top: 60px;">
            <h1>Tremor Guard</h1>
            <p>AI ê¸°ë°˜ ì§„ì „ ë¶„ì„ ì†”ë£¨ì…˜</p>
            <button id="loginBtnMain" onclick="login()">êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="subjectView" class="view">
        <div class="card">
            <h3>ëŒ€ìƒì ì„ íƒ ë° ì¶”ê°€</h3>
            <input type="text" id="newSubjectName" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="addSubject()">ì‹ ê·œ ì¶”ê°€</button>
            <ul id="subjectList" class="item-list"></ul>
        </div>
    </div>

    <div id="measureView" class="view">
        <div class="card">
            <div id="noiseAlert">âš ï¸ ë…¸ì´ì¦ˆ ê°ì§€ (ì›€ì§ì„ ì£¼ì˜)</div>
            <h3 id="currentSubjectTitle" style="margin-top:0;">ëŒ€ìƒì: </h3>
            <button id="startBtn">ì¸¡ì • ì‹œì‘</button>
            <div class="result-area">
                <div class="hz-display" id="result">0.0<span style="font-size:1.5rem"> Hz</span></div>
                <div id="probBox" class="prob-box">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
                <div id="status"></div>
            </div>
            <div class="chart-container">
                <canvas id="tremorChart"></canvas>
            </div>
        </div>
    </div>

    <div id="historyView" class="view">
        <div class="card">
            <h3>ì¸¡ì • ì´ë ¥ ë°ì´í„°</h3>
            <div style="overflow-x: auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                    <thead><tr style="background:#f8f9fa;"><th style="padding:10px;">ì´ë¦„</th><th>Hz</th><th>í™•ë¥ </th><th>ë‚ ì§œ</th></tr></thead>
                    <tbody id="historyBody" style="text-align:center;"></tbody>
                </table>
            </div>
            <button onclick="toggleMenu()" style="background:#eee; color:#333; margin-top:20px;">ë©”ë‰´ ì—´ê¸°</button>
        </div>
    </div>
</div>

<script>
    let currentUser = null, selectedSubject = null, isMeasuring = false, isLoggingIn = false;
    let accelData = [], chart;

    // --- ë„¤ë¹„ê²Œì´ì…˜ ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.getElementById('menuBtn').style.display = (viewId === 'loginView') ? 'none' : 'flex';
        // ëŒ€ìƒìê°€ ì„ íƒëœ ìƒíƒœë¼ë©´ 'ì¸¡ì • í™”ë©´ìœ¼ë¡œ' ë©”ë‰´ í‘œì‹œ
        document.getElementById('backToMeasureItem').style.display = selectedSubject ? 'block' : 'none';
        closeMenu();
    }
    function toggleMenu() { document.getElementById('menuOverlay').classList.toggle('open'); }
    function closeMenu() { document.getElementById('menuOverlay').classList.remove('open'); }
    function goToSubjectList() { showView('subjectView'); loadSubjects(); }

    // --- ì¸ì¦ ---
    async function login() {
        if (isLoggingIn) return;
        isLoggingIn = true;
        const btn = document.getElementById("loginBtnMain");
        btn.disabled = true; btn.innerText = "ë¡œê·¸ì¸ ì¤‘...";
        try { await auth.signInWithPopup(provider); }
        catch (err) { if (err.code !== 'auth/cancelled-popup-request') alert(err.message); }
        finally { isLoggingIn = false; btn.disabled = false; btn.innerText = "êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°"; }
    }
    function logout() { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) auth.signOut().then(() => location.reload()); }
    auth.onAuthStateChanged(user => { if (user) { currentUser = user; goToSubjectList(); } else { showView('loginView'); } });

    // --- ëŒ€ìƒì ê´€ë¦¬ (ì‚­ì œ ê¸°ëŠ¥ í¬í•¨) ---
    async function addSubject() {
        const name = document.getElementById('newSubjectName').value.trim();
        if (!name) return;
        await db.collection('subjects').add({ uid: currentUser.uid, name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        document.getElementById('newSubjectName').value = '';
        loadSubjects();
    }
    async function loadSubjects() {
        const snapshot = await db.collection('subjects').where('uid', '==', currentUser.uid).get();
        const list = document.getElementById('subjectList');
        list.innerHTML = '';
        snapshot.forEach(doc => {
            const sub = doc.data();
            const li = document.createElement('li');
            li.innerHTML = `<div onclick="startSession('${doc.id}', '${sub.name}')" style="flex:1; cursor:pointer;"><strong>${sub.name}</strong></div>
                            <div class="delete-btn" onclick="deleteSubject('${doc.id}')">ğŸ—‘ï¸</div>`;
            list.appendChild(li);
        });
    }
    async function deleteSubject(id) {
        if(confirm("ì´ ëŒ€ìƒìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.")) {
            await db.collection('subjects').doc(id).delete();
            loadSubjects();
        }
    }
    function startSession(id, name) {
        selectedSubject = { id, name };
        document.getElementById('currentSubjectTitle').innerText = `ëŒ€ìƒì: ${name}`;
        showView('measureView');
        initChart();
    }

    // --- ì¸¡ì • ë° ë¶„ì„ ë¡œì§ ---
    function initChart() {
        if(chart) chart.destroy();
        const ctx = document.getElementById('tremorChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'ì§„ë™', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { min: 0, max: 8 } }, animation: false }
        });
    }

    const startBtn = document.getElementById('startBtn');
    startBtn.addEventListener('click', () => {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission().then(state => { if(state === 'granted') runCountdown(); });
        } else { runCountdown(); }
    });

    // 1ë‹¨ê³„: ìì„¸ ì¤€ë¹„ (5ì´ˆ) - ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ˜ì •
    function runCountdown() {
        let timeLeft = 5;
        startBtn.disabled = true;
        document.getElementById('status').innerText = "ì¤€ë¹„: ì†ì„ í¸ì•ˆíˆ í•˜ê³  ê¸°ë‹¤ë¦¬ì„¸ìš”.";
        document.getElementById('probBox').innerText = "ë¶„ì„ ëŒ€ê¸° ì¤‘...";
        document.getElementById('probBox').style.background = "#f8f9fa";
        document.getElementById('probBox').style.color = "var(--primary)";

        const timer = setInterval(() => {
            startBtn.innerText = `ìì„¸ ì¤€ë¹„ ì¤‘... ${timeLeft}s`;
            if (timeLeft-- <= 0) { clearInterval(timer); startMeasuring(); }
        }, 1000);
    }

    // 2ë‹¨ê³„: ì‹¤ì œ ì¸¡ì • (5ì´ˆ) - ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œê°í™”
    function startMeasuring() {
        isMeasuring = true; accelData = [];
        chart.data.labels = []; chart.data.datasets[0].data = [];
        let measureTimeLeft = 5;
        
        const measureTimer = setInterval(() => {
            startBtn.innerText = `ì¸¡ì • ì¤‘... ${measureTimeLeft}s`;
            if (measureTimeLeft-- <= 0) { clearInterval(measureTimer); }
        }, 1000);

        window.addEventListener('devicemotion', processMotion);
        setTimeout(stopMeasuring, 5000);
    }

    function processMotion(event) {
        if (!isMeasuring) return;
        const acc = event.acceleration;
        if (!acc || !acc.x) return;
        const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        if (mag > 13.0) document.getElementById('noiseAlert').style.display = 'block';
        else setTimeout(() => document.getElementById('noiseAlert').style.display = 'none', 500);
        accelData.push(mag);
        if (accelData.length % 5 === 0) {
            chart.data.labels.push(""); chart.data.datasets[0].data.push(mag); chart.update();
        }
    }

    function stopMeasuring() {
        isMeasuring = false;
        window.removeEventListener('devicemotion', processMotion);
        startBtn.disabled = false; startBtn.innerText = "ì¬ì¸¡ì •";
        analyze();
    }

    // 3ë‹¨ê³„: ìƒì„¸ ë¶„ì„ ë¡œì§ ë³µêµ¬
    async function analyze() {
        const n = accelData.length;
        if (n === 0) return;
        const mean = accelData.reduce((a, b) => a + b, 0) / n;
        const processed = accelData.map(v => v - mean);
        let peaks = 0, ampSum = 0;
        for (let i = 1; i < n - 1; i++) {
            if (processed[i] > 0.35 && processed[i] > processed[i-1] && processed[i] > processed[i+1]) {
                peaks++; ampSum += processed[i];
            }
        }
        const hz = (peaks / 5).toFixed(1);
        const avgAmp = (ampSum / (peaks || 1)).toFixed(2);
        
        // í”¼ë¡œë„ í™•ë¥  ê³„ì‚°
        let fatigueProb = 0;
        if (hz >= 3.5 && hz <= 6.5) fatigueProb += 50; 
        else if (hz > 6.5 && hz <= 12) fatigueProb += 30; 
        if (avgAmp > 0.8) fatigueProb += 20;
        if (avgAmp > 1.5) fatigueProb += 30;
        fatigueProb = Math.min(fatigueProb, 100);

        // UI ì—…ë°ì´íŠ¸
        const probBox = document.getElementById('probBox');
        const statusDiv = document.getElementById('status');
        document.getElementById('result').innerHTML = `${hz}<span style="font-size:1.5rem"> Hz</span>`;
        probBox.innerText = `í”¼ë¡œë„ í™•ë¥ : ${fatigueProb}%`;

        if (fatigueProb >= 80) {
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            probBox.style.background = "var(--danger)";
            probBox.style.color = "white";
            statusDiv.innerHTML = `<b style="color:var(--danger)">âš ï¸ ìœ„í—˜: ì¦‰ì‹œ íœ´ì‹ ê¶Œê³ </b><br>ë†’ì€ ì§„ì „ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        } else {
            probBox.style.background = "var(--success)";
            probBox.style.color = "white";
            statusDiv.innerHTML = `âœ… ì •ìƒ: ì•ˆì •ì  ìƒíƒœ`;
        }
        saveData(hz, fatigueProb);
    }

    async function saveData(hz, prob) {
        await db.collection('measurements').add({
            uid: currentUser.uid, subjectId: selectedSubject.id, subjectName: selectedSubject.name,
            hz, prob, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    async function showHistory() {
        showView('historyView');
        const snapshot = await db.collection('measurements').where('uid', '==', currentUser.uid).get();
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="padding:10px;">${data.subjectName}</td><td>${data.hz}</td><td>${data.prob}%</td><td>${date}</td>`;
            tbody.appendChild(tr);
        });
    }
</script>
</body>
</html>