<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Tremor Guard Pro v3.0</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --warning: #f39c12; --success: #27ae60; --light: #f4f7f9; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light); color: var(--primary); margin: 0; padding: 0; overflow-x: hidden; }
        .container { max-width: 450px; margin: auto; padding: 20px; box-sizing: border-box; min-height: 100vh; position: relative; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 12px 40px rgba(0,0,0,0.1); position: relative; }
        .view { display: none; }
        .view.active { display: block; }
        .menu-btn { position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; border-radius: 50%; width: 45px; height: 45px; display: none; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 1.5rem; }
        .menu-overlay { position: fixed; top: 0; right: -100%; width: 280px; height: 100%; background: white; z-index: 1001; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 70px 20px 20px 20px; box-sizing: border-box; }
        .menu-overlay.open { right: 0; }
        .menu-item { padding: 18px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; }
        .menu-close { position: absolute; top: 20px; left: 20px; font-size: 1.2rem; cursor: pointer; }
        button { background: var(--accent); color: white; border: none; padding: 15px; font-size: 1.1rem; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        button:disabled { background: #bdc3c7; }
        button.export-btn { background: var(--success); margin-top: 15px; font-size: 0.9rem; padding: 10px; }
        input, select { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 10px; }
        .item-list { list-style: none; padding: 0; margin-top: 20px; }
        .item-list li { background: #fff; padding: 16px; border-radius: 14px; margin-bottom: 12px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .hz-display { font-size: 3.8rem; font-weight: 900; margin: 15px 0; text-align: center; }
        .prob-box { font-weight: bold; padding: 12px; border-radius: 14px; background: #f8f9fa; margin-bottom: 10px; text-align: center; }
        .chart-container { height: 160px; margin-top: 15px; }
        #status { font-size: 0.9rem; text-align: center; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="menuBtn" class="menu-btn" onclick="toggleMenu()">â˜°</div>
    <div id="menuOverlay" class="menu-overlay">
        <div class="menu-close" onclick="toggleMenu()">âœ• ë‹«ê¸°</div>
        <div id="backToMeasureItem" class="menu-item" style="color: var(--accent); display:none;" onclick="showView('measureView')">ğŸ  í˜„ì¬ ì¸¡ì • í™”ë©´ìœ¼ë¡œ</div>
        <div class="menu-item" onclick="showHistory()">ğŸ“Š ë°ì´í„° ë¹„êµ í…Œì´ë¸”</div>
        <div class="menu-item" onclick="goToSubjectList()">ğŸ‘¥ ëŒ€ìƒì ëª©ë¡ (ë³€ê²½)</div>
        <div class="menu-item" style="color: var(--danger);" onclick="logout()">ğŸƒ ë¡œê·¸ì•„ì›ƒ</div>
    </div>

    <div id="loginView" class="view active">
        <div class="card" style="text-align: center; margin-top: 60px;">
            <h1>Tremor Guard <span style="font-size: 0.5em; vertical-align: middle;">PRO</span></h1>
            <button onclick="login()">êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="subjectView" class="view">
        <div class="card">
            <h3>ëŒ€ìƒì ì„ íƒ</h3>
            <input type="text" id="newSubjectName" placeholder="ì„±í•¨ ì…ë ¥">
            <button onclick="addSubject()">ëŒ€ìƒì ì¶”ê°€</button>
            <ul id="subjectList" class="item-list"></ul>
        </div>
    </div>

    <div id="measureView" class="view">
        <div class="card">
            <h3 id="currentSubjectTitle" style="margin-top:0;">ëŒ€ìƒì: </h3>
            <button id="startBtn">ì¸¡ì • ì‹œì‘</button>
            <div class="hz-display" id="result">0.0<span style="font-size:1.5rem"> Hz</span></div>
            <div id="probBox" class="prob-box">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
            <div id="status"></div>
            <div class="chart-container"><canvas id="tremorChart"></canvas></div>
        </div>
    </div>

    <div id="historyView" class="view">
        <div class="card">
            <select id="subjectFilter" onchange="filterHistoryBySelect()"></select>
            <button class="export-btn" onclick="exportToCSV()">ğŸ“‚ ì—‘ì…€(CSV) ë‚´ë³´ë‚´ê¸°</button>
            <div style="overflow-x: auto; margin-top:15px;">
                <table style="width:100%; border-collapse:collapse; font-size:0.75rem;">
                    <thead><tr style="background:#f8f9fa;"><th>ì´ë¦„</th><th>Hz</th><th>ì§„í­</th><th>ë°©í–¥</th><th>ë‚ ì§œ</th></tr></thead>
                    <tbody id="historyBody" style="text-align:center;"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUser = null, selectedSubject = null, isMeasuring = false;
    let rawAccelData = []; // {x, y, z, mag} ê°ì²´ ì €ì¥
    let chart, countdownInterval, measureInterval, startTime, endTime;
    let lastFilteredMag = 0; 
    const alpha = 0.7; // LPF ê³„ìˆ˜

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.getElementById('menuBtn').style.display = (viewId === 'loginView') ? 'none' : 'flex';
        document.getElementById('backToMeasureItem').style.display = selectedSubject ? 'block' : 'none';
        closeMenu();
    }
    function toggleMenu() { document.getElementById('menuOverlay').classList.toggle('open'); }
    function closeMenu() { document.getElementById('menuOverlay').classList.remove('open'); }
    function goToSubjectList() { showView('subjectView'); loadSubjects(); }

    async function login() { await auth.signInWithPopup(provider).catch(console.error); }
    function logout() { auth.signOut().then(() => location.reload()); }
    auth.onAuthStateChanged(user => { if (user) { currentUser = user; goToSubjectList(); } else { showView('loginView'); } });

    async function addSubject() {
        const name = document.getElementById('newSubjectName').value.trim();
        if (!name) return;
        await db.collection('subjects').add({ uid: currentUser.uid, name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        document.getElementById('newSubjectName').value = ''; loadSubjects();
    }
    async function loadSubjects() {
        const snapshot = await db.collection('subjects').where('uid', '==', currentUser.uid).get();
        const list = document.getElementById('subjectList');
        const filter = document.getElementById('subjectFilter');
        list.innerHTML = ''; filter.innerHTML = '<option value="all">ëª¨ë“  ëŒ€ìƒì</option>';
        snapshot.forEach(doc => {
            const sub = doc.data();
            list.innerHTML += `<li><div onclick="startSession('${doc.id}', '${sub.name}')" style="flex:1;"><strong>${sub.name}</strong></div>
                               <span onclick="showHistory('${doc.id}')" style="color:var(--accent); cursor:pointer;">ğŸ“Š</span></li>`;
            filter.innerHTML += `<option value="${doc.id}">${sub.name}</option>`;
        });
    }

    function startSession(id, name) {
        selectedSubject = { id, name };
        document.getElementById('currentSubjectTitle').innerText = `ëŒ€ìƒì: ${name}`;
        showView('measureView'); initChart();
    }

    function initChart() {
        if(chart) chart.destroy();
        const ctx = document.getElementById('tremorChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'ê°•ë„', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { min: 0, max: 8 } }, animation: false }
        });
    }

    const startBtn = document.getElementById('startBtn');
    startBtn.onclick = () => {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission().then(state => { if(state === 'granted') runCountdown(); });
        } else { runCountdown(); }
    };

    function runCountdown() {
        let timeLeft = 5; startBtn.disabled = true;
        countdownInterval = setInterval(() => {
            startBtn.innerText = `ì¤€ë¹„ ì¤‘... ${timeLeft}s`;
            if (timeLeft-- <= 0) { clearInterval(countdownInterval); startMeasuring(); }
        }, 1000);
    }

    function startMeasuring() {
        isMeasuring = true; rawAccelData = []; lastFilteredMag = 0;
        startTime = Date.now();
        startBtn.innerText = "ì¸¡ì • ì¤‘... 5s";
        let mTimeLeft = 5;
        measureInterval = setInterval(() => {
            mTimeLeft--; if(mTimeLeft >= 0) startBtn.innerText = `ì¸¡ì • ì¤‘... ${mTimeLeft}s`;
        }, 1000);
        window.addEventListener('devicemotion', processMotion);
        setTimeout(stopMeasuring, 5000);
    }

    function processMotion(event) {
        if (!isMeasuring) return;
        const acc = event.acceleration; if (!acc || !acc.x) return;
        const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        const filteredMag = (alpha * lastFilteredMag) + ((1 - alpha) * mag);
        lastFilteredMag = filteredMag;
        rawAccelData.push({ x: acc.x, y: acc.y, z: acc.z, mag: filteredMag });
        if (rawAccelData.length % 5 === 0) {
            chart.data.labels.push(""); chart.data.datasets[0].data.push(filteredMag); chart.update();
        }
    }

    function stopMeasuring() {
        endTime = Date.now(); isMeasuring = false;
        clearInterval(measureInterval); window.removeEventListener('devicemotion', processMotion);
        startBtn.disabled = false; startBtn.innerText = "ì¬ì¸¡ì •";
        analyze();
    }

    async function analyze() {
        const n = rawAccelData.length; if (n === 0) return;
        const duration = (endTime - startTime) / 1000;
        
        // ê° ì¶•ë³„ í‰ê·  ê³„ì‚°
        const meanX = rawAccelData.reduce((s, a) => s + a.x, 0) / n;
        const meanY = rawAccelData.reduce((s, a) => s + a.y, 0) / n;
        const meanZ = rawAccelData.reduce((s, a) => s + a.z, 0) / n;
        const meanMag = rawAccelData.reduce((s, a) => s + a.mag, 0) / n;

        let peaks = 0, ampSum = 0, ampX = 0, ampY = 0, ampZ = 0;
        rawAccelData.forEach((d, i) => {
            if (i > 0 && i < n - 1) {
                const prev = rawAccelData[i-1].mag - meanMag;
                const curr = d.mag - meanMag;
                const next = rawAccelData[i+1].mag - meanMag;
                if (curr > 0.4 && curr > prev && curr > next) {
                    peaks++; ampSum += curr;
                    ampX += Math.abs(d.x - meanX);
                    ampY += Math.abs(d.y - meanY);
                    ampZ += Math.abs(d.z - meanZ);
                }
            }
        });

        const hz = (peaks / duration).toFixed(1);
        const avgAmp = (ampSum / (peaks || 1)).toFixed(2);
        const axes = { X: (ampX/peaks || 0).toFixed(2), Y: (ampY/peaks || 0).toFixed(2), Z: (ampZ/peaks || 0).toFixed(2) };
        const domAxis = Object.keys(axes).reduce((a, b) => axes[a] > axes[b] ? a : b);

        document.getElementById('result').innerHTML = `${hz}<span> Hz</span>`;
        document.getElementById('status').innerText = `ì£¼ìš” ë°©í–¥: ${domAxis}ì¶• (ê°•ë„: ${axes[domAxis]})`;
        
        saveData(hz, avgAmp, domAxis, axes);
    }

    async function saveData(hz, amp, dir, axes) {
        await db.collection('measurements').add({
            uid: currentUser.uid, subjectId: selectedSubject.id, subjectName: selectedSubject.name,
            hz, amp, direction: dir, ampX: axes.X, ampY: axes.Y, ampZ: axes.Z,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    // --- ì´ë ¥ ë° CSV ë‚´ë³´ë‚´ê¸° ---
    let currentHistoryData = [];
    async function showHistory(targetId = null) {
        showView('historyView');
        const filter = document.getElementById('subjectFilter');
        filter.value = targetId || 'all';
        let query = db.collection('measurements').where('uid', '==', currentUser.uid);
        if (targetId && targetId !== 'all') query = query.where('subjectId', '==', targetId);
        
        const snap = await query.get();
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = ''; currentHistoryData = [];
        snap.forEach(doc => currentHistoryData.push(doc.data()));
        currentHistoryData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

        currentHistoryData.forEach(d => {
            const date = d.timestamp ? d.timestamp.toDate().toLocaleDateString() : '-';
            tbody.innerHTML += `<tr><td>${d.subjectName}</td><td>${d.hz}</td><td>${d.amp}</td><td>${d.direction}</td><td>${date}</td></tr>`;
        });
    }

    function filterHistoryBySelect() { showHistory(document.getElementById('subjectFilter').value); }

    function exportToCSV() {
        if (currentHistoryData.length === 0) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        let csv = "\uFEFFì´ë¦„,ì£¼íŒŒìˆ˜(Hz),í‰ê· ì§„í­,ì£¼ìš”ë°©í–¥,ì§„í­X,ì§„í­Y,ì§„í­Z,ë‚ ì§œ\n";
        currentHistoryData.forEach(d => {
            const date = d.timestamp ? d.timestamp.toDate().toLocaleString() : '-';
            csv += `${d.subjectName},${d.hz},${d.amp},${d.direction},${d.ampX},${d.ampY},${d.ampZ},${date}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Tremor_Data_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }
</script>
</body>
</html>