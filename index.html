<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Tremor Guard Pro</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --warning: #f39c12; --success: #27ae60; --light: #f4f7f9; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light); color: var(--primary); margin: 0; padding: 0; overflow-x: hidden; }
        
        .container { max-width: 450px; margin: auto; padding: 20px; box-sizing: border-box; min-height: 100vh; position: relative; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 12px 40px rgba(0,0,0,0.1); position: relative; }
        
        /* í™”ë©´ ì œì–´ */
        .view { display: none; }
        .view.active { display: block; }

        /* ë©”ë‰´ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ê³ ì •) */
        .menu-btn { position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; border-radius: 50%; width: 45px; height: 45px; display: none; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 1.5rem; }
        
        /* ë©”ë‰´ ì˜¤ë²„ë ˆì´ */
        .menu-overlay { position: fixed; top: 0; right: -100%; width: 260px; height: 100%; background: white; z-index: 1001; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 70px 20px 20px 20px; box-sizing: border-box; }
        .menu-overlay.open { right: 0; }
        .menu-item { padding: 18px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; color: var(--primary); }
        .menu-item:active { background-color: #f0f0f0; }
        .menu-close { position: absolute; top: 20px; left: 20px; font-size: 1.2rem; cursor: pointer; color: #777; }

        /* ê³µí†µ ë²„íŠ¼ ë° ì…ë ¥ì°½ */
        button { background: var(--accent); color: white; border: none; padding: 15px; font-size: 1.1rem; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; }
        
        .item-list { list-style: none; padding: 0; margin-top: 20px; max-height: 450px; overflow-y: auto; }
        .item-list li { background: #fff; padding: 16px; border-radius: 14px; margin-bottom: 12px; cursor: pointer; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }

        /* ì¸¡ì • UI */
        .hz-display { font-size: 3.8rem; font-weight: 900; margin: 15px 0; text-align: center; color: var(--primary); }
        .prob-box { font-weight: bold; padding: 12px; border-radius: 14px; background: #f8f9fa; margin-bottom: 10px; text-align: center; }
        .chart-container { height: 180px; margin-top: 20px; background: #fff; border-radius: 12px; }
        #noiseAlert { display: none; background: var(--warning); color: white; padding: 10px; font-size: 0.85rem; text-align: center; border-radius: 10px; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="menuBtn" class="menu-btn" onclick="toggleMenu()">â˜°</div>

    <div id="menuOverlay" class="menu-overlay">
        <div class="menu-close" onclick="toggleMenu()">âœ• ë‹«ê¸°</div>
        <div class="menu-item" onclick="showHistory()">ğŸ“Š ë°ì´í„° ë¹„êµ í…Œì´ë¸”</div>
        <div class="menu-item" onclick="goToSubjectList()">ğŸ‘¥ ëŒ€ìƒì ëª©ë¡ (ë³€ê²½)</div>
        <div class="menu-item" style="color: var(--danger);" onclick="logout()">ğŸƒ ë¡œê·¸ì•„ì›ƒ</div>
    </div>

    <div id="loginView" class="view active">
        <div class="card" style="text-align: center; margin-top: 60px;">
            <h1 style="margin-bottom:10px;">Tremor Guard</h1>
            <p style="color:#7f8c8d; margin-bottom:30px;">Professional Analysis Tool</p>
            <button id="loginBtnMain" onclick="login()">êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="subjectView" class="view">
        <div class="card">
            <h3>ëŒ€ìƒì ì„ íƒ ë° ì¶”ê°€</h3>
            <input type="text" id="newSubjectName" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="addSubject()">ì‹ ê·œ ì¶”ê°€</button>
            <ul id="subjectList" class="item-list"></ul>
        </div>
    </div>

    <div id="measureView" class="view">
        <div class="card">
            <div id="noiseAlert">âš ï¸ ì›€ì§ì„ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
            <h3 id="currentSubjectTitle" style="margin-top:0; color:var(--accent);">ëŒ€ìƒì: </h3>
            <button id="startBtn">ì¸¡ì • ì‹œì‘</button>
            <div class="result-area">
                <div class="hz-display" id="result">0.0<span style="font-size:1.5rem"> Hz</span></div>
                <div id="probBox" class="prob-box">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
                <div id="status" style="font-size:0.9rem; text-align:center; min-height:2em; color:#7f8c8d;"></div>
            </div>
            <div class="chart-container">
                <canvas id="tremorChart"></canvas>
            </div>
        </div>
    </div>

    <div id="historyView" class="view">
        <div class="card">
            <h3>ì¸¡ì • ì´ë ¥ ë°ì´í„°</h3>
            <div style="overflow-x: auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px;">
                    <thead>
                        <tr style="border-bottom:2px solid #eee; background:#f8f9fa;">
                            <th style="padding:12px;">ëŒ€ìƒì</th><th style="padding:12px;">Hz</th><th style="padding:12px;">í™•ë¥ </th><th style="padding:12px;">ë‚ ì§œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody" style="text-align:center;"></tbody>
                </table>
            </div>
            <button onclick="toggleMenu()" style="background:#f1f2f6; color:#2f3542; margin-top:20px;">ë©”ë‰´ ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let selectedSubject = null;
    let isMeasuring = false;
    let isLoggingIn = false;
    let accelData = [];
    let chart;

    // --- í™”ë©´ ì œì–´ ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.getElementById('menuBtn').style.display = (viewId === 'loginView') ? 'none' : 'flex';
        closeMenu();
    }

    function toggleMenu() { document.getElementById('menuOverlay').classList.toggle('open'); }
    function closeMenu() { document.getElementById('menuOverlay').classList.remove('open'); }
    function goToSubjectList() { showView('subjectView'); loadSubjects(); }

    // --- Firebase ì¸ì¦ (íŒì—… ë°©ì‹ + ê²¬ê³ í•œ ì—ëŸ¬ ì²˜ë¦¬) ---
    async function login() {
        if (isLoggingIn) return; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        
        isLoggingIn = true;
        const loginBtn = document.getElementById("loginBtnMain");
        loginBtn.disabled = true;
        loginBtn.innerText = "ë¡œê·¸ì¸ ì¤‘...";

        try {
            // íŒì—… ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë£¨í”„ ë¬¸ì œ í•´ê²°
            await auth.signInWithPopup(provider);
            // ì„±ê³µ ì‹œ onAuthStateChangedê°€ ê°ì§€í•˜ì—¬ í™”ë©´ì„ ë„˜ê¹ë‹ˆë‹¤.
        } catch (err) {
            console.error("Login Error:", err);
            // íŒì—… ì¶©ëŒì´ë‚˜ ì·¨ì†Œ ì—ëŸ¬ê°€ ì•„ë‹ ë•Œë§Œ ì•Œë¦¼ í‘œì‹œ
            if (err.code !== 'auth/cancelled-popup-request') {
                alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            }
        } finally {
            isLoggingIn = false;
            loginBtn.disabled = false;
            loginBtn.innerText = "êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°";
        }
    }

    function logout() {
        if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            auth.signOut().then(() => { location.reload(); });
        }
    }

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€ (ì•±ì˜ ì‹¬ì¥ë¶€)
    auth.onAuthStateChanged(user => {
        console.log("ì¸ì¦ ìƒíƒœ í™•ì¸:", user ? "ë¡œê·¸ì¸ë¨" : "ë¡œê·¸ì•„ì›ƒë¨");
        if (user) {
            currentUser = user;
            goToSubjectList(); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ëŒ€ìƒì ëª©ë¡ í™”ë©´ìœ¼ë¡œ ì „í™˜
        } else {
            showView('loginView'); // ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
        }
    });

    // --- ëŒ€ìƒì ê´€ë¦¬ ë¡œì§ ---
    async function addSubject() {
        const nameInput = document.getElementById('newSubjectName');
        const name = nameInput.value.trim();
        if (!name) return alert("ëŒ€ìƒì ì„±í•¨ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

        try {
            await db.collection('subjects').add({
                uid: currentUser.uid,
                name: name,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            nameInput.value = '';
            loadSubjects(); // ì¶”ê°€ í›„ ëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 
        } catch (error) {
            console.error(error);
            alert("ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: Firestore ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
    }

    async function loadSubjects() {
        try {
            const snapshot = await db.collection('subjects')
                .where('uid', '==', currentUser.uid)
                .get();
            
            const list = document.getElementById('subjectList');
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const sub = doc.data();
                const li = document.createElement('li');
                li.innerHTML = `<strong>${sub.name}</strong> <span style="font-size:0.8rem; color:var(--accent)">ì„ íƒ</span>`;
                li.onclick = () => startSession(doc.id, sub.name);
                list.appendChild(li);
            });
        } catch (error) { console.error("Load Error:", error); }
    }

    function startSession(id, name) {
        selectedSubject = { id, name };
        document.getElementById('currentSubjectTitle').innerText = `ëŒ€ìƒì: ${name}`;
        showView('measureView');
        initChart();
    }

    // --- ì§„ì „ ì¸¡ì • ë¡œì§ (ê°€ì†ë„ê³„ í™œìš©) ---
    function initChart() {
        if(chart) chart.destroy();
        const ctx = document.getElementById('tremorChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'ì§„ë™ ê°•ë„', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { min: 0, max: 8 } }, animation: false }
        });
    }

    const startBtn = document.getElementById('startBtn');
    startBtn.addEventListener('click', () => {
        // iOS ê¶Œí•œ ìš”ì²­ ì²˜ë¦¬
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission().then(state => { 
                if(state === 'granted') runCountdown(); 
                else alert("ê°€ì†ë„ê³„ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            });
        } else { runCountdown(); }
    });

    function runCountdown() {
        let timeLeft = 5;
        startBtn.disabled = true;
        const timer = setInterval(() => {
            startBtn.innerText = `ì¤€ë¹„ í•˜ì„¸ìš”... ${timeLeft}s`;
            if (timeLeft-- <= 0) { clearInterval(timer); startMeasuring(); }
        }, 1000);
    }

    function startMeasuring() {
        isMeasuring = true; accelData = [];
        startBtn.innerText = `ì¸¡ì • ì¤‘... 5s`;
        window.addEventListener('devicemotion', processMotion);
        setTimeout(stopMeasuring, 5000);
    }

    function processMotion(event) {
        if (!isMeasuring) return;
        const acc = event.acceleration;
        if (!acc || !acc.x) return;
        const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        
        if (mag > 13.0) document.getElementById('noiseAlert').style.display = 'block';
        else setTimeout(() => document.getElementById('noiseAlert').style.display = 'none', 500);

        accelData.push(mag);
        if (accelData.length % 5 === 0) {
            chart.data.labels.push("");
            chart.data.datasets[0].data.push(mag);
            chart.update();
        }
    }

    function stopMeasuring() {
        isMeasuring = false;
        window.removeEventListener('devicemotion', processMotion);
        startBtn.disabled = false;
        startBtn.innerText = "ì¬ì¸¡ì • í•˜ê¸°";
        analyze();
    }

    async function analyze() {
        const n = accelData.length;
        if (n === 0) return;
        const mean = accelData.reduce((a, b) => a + b, 0) / n;
        const processed = accelData.map(v => v - mean);
        let peaks = 0, ampSum = 0;
        for (let i = 1; i < n - 1; i++) {
            if (processed[i] > 0.35 && processed[i] > processed[i-1] && processed[i] > processed[i+1]) {
                peaks++; ampSum += processed[i];
            }
        }
        const hz = (peaks / 5).toFixed(1);
        const avgAmp = (ampSum / (peaks || 1)).toFixed(2);
        let prob = 0;
        if (hz >= 3.5 && hz <= 6.5) prob += 50; else if (hz > 6.5 && hz <= 12) prob += 30;
        if (avgAmp > 0.8) prob += 20; if (avgAmp > 1.5) prob += 30;
        prob = Math.min(prob, 100);

        document.getElementById('result').innerHTML = `${hz}<span> Hz</span>`;
        document.getElementById('probBox').innerText = `í”¼ë¡œë„ í™•ë¥ : ${prob}%`;
        saveData(hz, prob); // ë¶„ì„ ê²°ê³¼ DB ì €ì¥
    }

    async function saveData(hz, prob) {
        try {
            await db.collection('measurements').add({
                uid: currentUser.uid,
                subjectId: selectedSubject.id,
                subjectName: selectedSubject.name,
                hz: hz,
                prob: prob,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch(e) { console.error("Save error:", e); }
    }

    async function showHistory() {
        showView('historyView');
        try {
            const snapshot = await db.collection('measurements')
                .where('uid', '==', currentUser.uid)
                .get();
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="padding:12px;">${data.subjectName}</td><td>${data.hz}</td><td>${data.prob}%</td><td>${date}</td>`;
                tbody.appendChild(tr);
            });
        } catch (e) { console.error("History Load Error:", e); }
    }
</script>

</body>
</html>