<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Tremor Guard Pro</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --warning: #f39c12; --success: #27ae60; --light: #f4f7f9; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light); color: var(--primary); margin: 0; padding: 0; overflow-x: hidden; }
        
        .container { max-width: 450px; margin: auto; padding: 20px; box-sizing: border-box; min-height: 100vh; position: relative; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 12px 40px rgba(0,0,0,0.1); position: relative; }
        
        /* í™”ë©´ ì œì–´ */
        .view { display: none; }
        .view.active { display: block; }

        /* ë©”ë‰´ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨) */
        .menu-btn { position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; border-radius: 50%; width: 45px; height: 45px; display: none; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 1.5rem; }
        
        /* ë©”ë‰´ ì˜¤ë²„ë ˆì´ */
        .menu-overlay { position: fixed; top: 0; right: -100%; width: 250px; height: 100%; background: white; z-index: 1001; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 60px 20px 20px 20px; }
        .menu-overlay.open { right: 0; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; }
        .menu-close { position: absolute; top: 20px; left: 20px; font-size: 1.2rem; cursor: pointer; }

        /* ë²„íŠ¼ ë° ì…ë ¥ì°½ */
        button { background: var(--accent); color: white; border: none; padding: 15px; font-size: 1.1rem; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 10px; }
        
        .item-list { list-style: none; padding: 0; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .item-list li { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid #eee; display: flex; justify-content: space-between; }

        /* ì¸¡ì • UI */
        .hz-display { font-size: 3.5rem; font-weight: 900; margin: 15px 0; text-align: center; }
        .prob-box { font-weight: bold; padding: 10px; border-radius: 12px; background: #f8f9fa; margin-bottom: 10px; text-align: center; }
        .chart-container { height: 180px; margin-top: 15px; }
        #noiseAlert { display: none; background: var(--warning); color: white; padding: 8px; font-size: 0.8rem; text-align: center; border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="menuBtn" class="menu-btn" onclick="toggleMenu()">â˜°</div>

    <div id="menuOverlay" class="menu-overlay">
        <div class="menu-close" onclick="toggleMenu()">âœ• ë‹«ê¸°</div>
        <div class="menu-item" onclick="showHistory()">ğŸ“Š ë°ì´í„° ë¹„êµ í…Œì´ë¸”</div>
        <div class="menu-item" onclick="goToSubjectList()">ğŸ‘¥ ëŒ€ìƒì ëª©ë¡ (ë³€ê²½)</div>
        <div class="menu-item" style="color: var(--danger);" onclick="logout()">ğŸƒ ë¡œê·¸ì•„ì›ƒ</div>
    </div>

    <div id="loginView" class="view active">
        <div class="card" style="text-align: center; margin-top: 50px;">
            <h2>Tremor Guard <span style="color:var(--accent)">Pro</span></h2>
            <p>ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ ì§„ì „ ë¶„ì„ ì†”ë£¨ì…˜</p>
            <button onclick="login()">êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="subjectView" class="view">
        <div class="card">
            <h3>ëŒ€ìƒì ê´€ë¦¬</h3>
            <input type="text" id="newSubjectName" placeholder="ìƒˆ ëŒ€ìƒì ì„±í•¨ ì…ë ¥">
            <button onclick="addSubject()">ëŒ€ìƒì ì¶”ê°€í•˜ê¸°</button>
            <ul id="subjectList" class="item-list"></ul>
        </div>
    </div>

    <div id="measureView" class="view">
        <div class="card">
            <div id="noiseAlert">âš ï¸ ë…¸ì´ì¦ˆ ê°ì§€ (ì›€ì§ì„ ì£¼ì˜)</div>
            <h3 id="currentSubjectTitle" style="margin-top:0;">ëŒ€ìƒì: </h3>
            <button id="startBtn">ì¸¡ì • ì‹œì‘</button>
            <div class="result-area">
                <div class="hz-display" id="result">0.0<span style="font-size:1.5rem"> Hz</span></div>
                <div id="probBox" class="prob-box">ì¤€ë¹„ ì™„ë£Œ</div>
                <div id="status" style="font-size:0.9rem; text-align:center; min-height:2em;"></div>
            </div>
            <div class="chart-container">
                <canvas id="tremorChart"></canvas>
            </div>
        </div>
    </div>

    <div id="historyView" class="view">
        <div class="card">
            <h3>ë°ì´í„° ë¶„ì„ ì´ë ¥</h3>
            <div style="overflow-x: auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                    <thead>
                        <tr style="border-bottom:2px solid #eee;">
                            <th style="padding:10px;">ì´ë¦„</th><th style="padding:10px;">Hz</th><th style="padding:10px;">í™•ë¥ </th><th style="padding:10px;">ë‚ ì§œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody" style="text-align:center;"></tbody>
                </table>
            </div>
            <button class="btn-outline" onclick="toggleMenu()" style="background:#eee; color:#333; margin-top:20px;">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let selectedSubject = null;
    let isMeasuring = false;
    let accelData = [];
    let chart;

    // --- í™”ë©´ ë° ë©”ë‰´ ì œì–´ ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        // ë¡œê·¸ì¸ í™”ë©´ì´ ì•„ë‹ ë•Œë§Œ ë©”ë‰´ ë²„íŠ¼ í‘œì‹œ
        document.getElementById('menuBtn').style.display = (viewId === 'loginView') ? 'none' : 'flex';
        closeMenu();
    }

    function toggleMenu() { document.getElementById('menuOverlay').classList.toggle('open'); }
    function closeMenu() { document.getElementById('menuOverlay').classList.remove('open'); }
    function goToSubjectList() { showView('subjectView'); loadSubjects(); }

    // --- Firebase ì¸ì¦ ---
    function login() { auth.signInWithPopup(provider).catch(err => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message)); }
    function logout() { auth.signOut().then(() => { location.reload(); }); }

    auth.onAuthStateChanged(user => {
        if (user) { currentUser = user; goToSubjectList(); }
        else { showView('loginView'); }
    });

    // --- ëŒ€ìƒì ê´€ë¦¬ (ìˆ˜ì •ëœ ë¶€ë¶„) ---
    async function addSubject() {
        const nameInput = document.getElementById('newSubjectName');
        const name = nameInput.value.trim();
        if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
            await db.collection('subjects').add({
                uid: currentUser.uid,
                name: name,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            nameInput.value = '';
            loadSubjects(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
            console.error("Error adding subject: ", error);
            alert("ëŒ€ìƒì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
    }

    async function loadSubjects() {
        try {
            // orderByë¥¼ ì œê±°í•˜ì—¬ ìƒ‰ì¸ ë¬¸ì œë¡œ ì¸í•œ ì¿¼ë¦¬ ì‹¤íŒ¨ ë°©ì§€ (ìš°ì„  ë™ì‘ í™•ì¸ìš©)
            const snapshot = await db.collection('subjects')
                .where('uid', '==', currentUser.uid)
                .get();
            
            const list = document.getElementById('subjectList');
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const sub = doc.data();
                const li = document.createElement('li');
                li.innerHTML = `<span>${sub.name}</span> <small style="color:var(--accent)">ì„ íƒ ></small>`;
                li.onclick = () => startSession(doc.id, sub.name);
                list.appendChild(li);
            });
        } catch (error) {
            console.error("Error loading subjects: ", error);
        }
    }

    function startSession(id, name) {
        selectedSubject = { id, name };
        document.getElementById('currentSubjectTitle').innerText = `ëŒ€ìƒì: ${name}`;
        showView('measureView');
        initChart();
    }

    // --- ì¸¡ì • ë¡œì§ (ì´ì „ê³¼ ë™ì¼í•˜ì§€ë§Œ ì¸í„°í˜ì´ìŠ¤ í†µí•©) ---
    function initChart() {
        if(chart) chart.destroy();
        const ctx = document.getElementById('tremorChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'ì§„ì „ ê°•ë„', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { min: 0, max: 8 } }, animation: false }
        });
    }

    const startBtn = document.getElementById('startBtn');
    startBtn.addEventListener('click', () => {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission().then(state => { if(state === 'granted') runCountdown(); });
        } else { runCountdown(); }
    });

    function runCountdown() {
        let timeLeft = 5;
        startBtn.disabled = true;
        const timer = setInterval(() => {
            startBtn.innerText = `ìì„¸ ì¤€ë¹„... ${timeLeft}s`;
            if (timeLeft-- <= 0) { clearInterval(timer); startMeasuring(); }
        }, 1000);
    }

    function startMeasuring() {
        isMeasuring = true; accelData = [];
        startBtn.innerText = `ì¸¡ì • ì¤‘... 5s`;
        window.addEventListener('devicemotion', processMotion);
        setTimeout(stopMeasuring, 5000);
    }

    function processMotion(event) {
        if (!isMeasuring) return;
        const acc = event.acceleration;
        if (!acc || !acc.x) return;
        const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        if (mag > 13.0) document.getElementById('noiseAlert').style.display = 'block';
        else setTimeout(() => document.getElementById('noiseAlert').style.display = 'none', 500);
        accelData.push(mag);
        if (accelData.length % 5 === 0) {
            chart.data.labels.push("");
            chart.data.datasets[0].data.push(mag);
            chart.update();
        }
    }

    function stopMeasuring() {
        isMeasuring = false;
        window.removeEventListener('devicemotion', processMotion);
        startBtn.disabled = false;
        startBtn.innerText = "ì¬ì¸¡ì •";
        analyze();
    }

    async function analyze() {
        const n = accelData.length;
        if (n === 0) return;
        const mean = accelData.reduce((a, b) => a + b, 0) / n;
        const processed = accelData.map(v => v - mean);
        let peaks = 0, ampSum = 0;
        for (let i = 1; i < n - 1; i++) {
            if (processed[i] > 0.35 && processed[i] > processed[i-1] && processed[i] > processed[i+1]) {
                peaks++; ampSum += processed[i];
            }
        }
        const hz = (peaks / 5).toFixed(1);
        const avgAmp = (ampSum / (peaks || 1)).toFixed(2);
        let prob = 0;
        if (hz >= 3.5 && hz <= 6.5) prob += 50; else if (hz > 6.5 && hz <= 12) prob += 30;
        if (avgAmp > 0.8) prob += 20; if (avgAmp > 1.5) prob += 30;
        prob = Math.min(prob, 100);

        document.getElementById('result').innerHTML = `${hz}<span> Hz</span>`;
        document.getElementById('probBox').innerText = `í”¼ë¡œë„ í™•ë¥ : ${prob}%`;
        saveData(hz, prob);
    }

    async function saveData(hz, prob) {
        try {
            await db.collection('measurements').add({
                uid: currentUser.uid,
                subjectId: selectedSubject.id,
                subjectName: selectedSubject.name,
                hz: hz,
                prob: prob,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch(e) { console.error(e); }
    }

    async function showHistory() {
        showView('historyView');
        const snapshot = await db.collection('measurements')
            .where('uid', '==', currentUser.uid)
            .get();
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : '-';
            const tr = document.createElement('tr');
            tr.style.borderBottom = "1px solid #eee";
            tr.innerHTML = `<td style="padding:10px;">${data.subjectName}</td><td>${data.hz}</td><td>${data.prob}%</td><td>${date}</td>`;
            tbody.appendChild(tr);
        });
    }
</script>

</body>
</html>